name: "Test Unlabel"
description: "On new commits, removes the label-done label if present and posts a comment."

inputs:
  label-needed:
    description: 'Label indicating the PR needs testing'
    required: false
    default: 'test-needed'
  label-done:
    description: 'Label indicating the PR has been tested'
    required: false
    default: 'test-done'
  test-name:
    description: 'Name of the test type used in comments (e.g. Robot)'
    required: false
    default: 'Test'
  token:
    description: 'GitHub token or PAT used to remove labels and post comments (defaults to github.token)'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Remove label and comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.token || github.token }}
        script: |
          const labelDone   = '${{ inputs.label-done }}';
          const labelNeeded = '${{ inputs.label-needed }}';
          const testName    = '${{ inputs.test-name }}';
          const { number: pr, head: { sha } } = context.payload.pull_request;
          const repo = context.repo;

          const postComment = async (body) => {
            try {
              await github.rest.issues.createComment({ ...repo, issue_number: pr, body });
            } catch (err) {
              core.warning(`Could not post comment: ${err.message}`);
            }
          };

          const { data: labels } = await github.rest.issues.listLabelsOnIssue({ ...repo, issue_number: pr });
          const has = new Set(labels.map(l => l.name));

          if (!has.has(labelDone)) {
            core.info(`\`${labelDone}\` not present. Nothing to do.`);
            return;
          }

          await github.rest.issues.removeLabel({ ...repo, issue_number: pr, name: labelDone });
          core.info(`\`${labelDone}\` removed.`);

          const shaLine = sha ? `\n\n**Commit:** \`${sha}\`` : '';
          const warning = !has.has(labelNeeded)
            ? `\n\n> [!WARNING]\n> \`${labelDone}\` was removed but \`${labelNeeded}\` was not present. This PR may not be queued for ${testName} testing.`
            : '';

          await postComment(
            `### ðŸ”„ ${testName} Label Removed\n\n` +
            `New commits were pushed. \`${labelDone}\` has been removed and ${testName} testing must be repeated.${shaLine}${warning}`
          );
