name: "Test Check Labels"
description: "Fails if label-needed is present but label-done is not."

inputs:
  label-needed:
    description: 'Label indicating the PR needs testing'
    required: false
    default: 'test-needed'
  label-done:
    description: 'Label indicating the PR has been tested'
    required: false
    default: 'test-done'
  test-name:
    description: 'Name of the test type used in comments (e.g. Robot)'
    required: false
    default: 'Test'
  token:
    description: 'GitHub token or PAT used to post comments (defaults to github.token)'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Check test labels
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.token || github.token }}
        script: |
          const labelNeeded = '${{ inputs.label-needed }}';
          const labelDone   = '${{ inputs.label-done }}';
          const testName    = '${{ inputs.test-name }}';
          const { number: pr, head: { sha } } = context.payload.pull_request;
          const repo = context.repo;

          const postComment = async (body) => {
            try {
              await github.rest.issues.createComment({ ...repo, issue_number: pr, body });
            } catch (err) {
              core.warning(`Could not post comment: ${err.message}`);
            }
          };

          const { data: labels } = await github.rest.issues.listLabelsOnIssue({ ...repo, issue_number: pr });
          const has = new Set(labels.map(l => l.name));

          if (!has.has(labelNeeded)) {
            core.info(`\`${labelNeeded}\` not present. No ${testName} testing required.`);
            return;
          }

          if (has.has(labelDone)) {
            core.info(`\`${labelDone}\` present. ${testName} testing confirmed.`);
            return;
          }

          const shaLine = sha ? `\n\n**Commit:** \`${sha}\`` : '';
          await postComment(
            `### âŒ ${testName} Testing Required\n\n` +
            `\`${labelNeeded}\` is present but \`${labelDone}\` has not been added. This PR cannot be merged until ${testName} testing is complete.${shaLine}\n\n` +
            `> [!IMPORTANT]\n> Add \`${labelDone}\` once ${testName} testing is complete.`
          );
          core.setFailed(`\`${labelNeeded}\` is present but \`${labelDone}\` has not been added. ${testName} testing must be completed before merging.`);
